
name: Maven Digitrans Tests

on:
  workflow_dispatch:
#  push:
#    branches:
#      - main
#      - '0.[0-9]+.[0-9]+'
#    paths:
#      - "metamart-service/**"
#      - "metamart-ui/**"
#      - "metamart-spec/src/main/resources/json/schema/**"
#      - "metamart-dist/**"
#      - "metamart-clients/**"
#      - "common/**"
#      - "pom.xml"
#      - "yarn.lock"
#      - "Makefile"
#      - "bootstrap/**"

permissions:
  contents: read
  checks: write

concurrency: 
  group: maven-build-digitrans-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true
jobs:
  maven-digitrans-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for the labeler
        uses: lewagon/wait-on-check-action@v1.3.3
        if: ${{ github.event_name == 'pull_request_target' }}
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: Team Label
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 90

      - name: Verify PR labels
        uses: jesusvasquez333/verify-pr-label-action@v1.4.0
        if: ${{ github.event_name == 'pull_request_target' }}
        with:
          github-token: '${{ secrets.GITHUB_TOKEN }}'
          valid-labels: 'safe to test'
          pull-request-number: '${{ github.event.pull_request.number }}'
          disable-reviews: true  # To not auto approve changes

      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Trigger Digitrans build & wait
        uses: aurelien-baudet/workflow-dispatch@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SHA: ${{ github.event_name == 'push' && github.event.after || github.event.pull_request.head.sha }}
        with:
          workflow: MetaMart Digitrans Test
          ref: main
          repo: meta-mart/metamart-digitrans
          token: ${{ secrets.DIGITRANS_PAT }}
          wait-for-completion: true
          inputs: '{ "sha": "${{ env.SHA }}" }'
